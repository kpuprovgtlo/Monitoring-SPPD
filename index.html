<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>Monitoring SPPD</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      padding: 0;
      background-color: #f9f9f9;
    }

    .header-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 20px;
      background-color: #fff;
      border-bottom: 1px solid #ddd;
    }

    .header-bar h1 {
      margin: 0;
      font-size: 24px;
      color: #444;
    }

    .status-box {
      font-size: 16px;
      color: #333;
      text-align: right;
    }

    .table-wrap {
      height: calc(100vh - 80px);
      overflow-y: auto;
      border-top: 1px solid #ccc;
      background-color: #fff;
      box-shadow: inset 0 1px 3px rgba(0,0,0,0.1);
    }

    table {
      border-collapse: separate;
      border-spacing: 0;
      width: 100%;
    }

    th, td {
      padding: 12px 16px;
      text-align: left;
      border-bottom: 1px solid #eee;
    }

    th {
      background-color: #800000;
      color: white;
      text-align: center;
      font-weight: bold;
      position: sticky;
      top: 0;
      z-index: 2;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }

    tr {
      transition: background-color 0.3s ease;
    }

    tr:hover {
      background-color: #f0f8ff;
    }

    tr.belum td {
      color: #d10000;
      font-weight: bold;
    }

    tr.active {
      outline: 2px solid #3399ff;
      background-color: #e6f2ff !important;
      box-shadow: inset 0 0 5px rgba(51,153,255,0.3);
    }

    td {
      background-color: #fff;
      border-left: 1px solid #f0f0f0;
    }

    td:first-child {
      border-left: none;
    }

    table tr:last-child td {
      border-bottom: none;
    }
  </style>
</head>
<body>
  <div class="header-bar">
    <h1>MONITOR SPPD</h1>
    <div id="status-summary" class="status-box"></div>
  </div>

  <div class="table-wrap" id="scroll-container">
    <table id="data-table"></table>
  </div>

  <script>
    const API_URL = "https://script.google.com/macros/s/AKfycby2RAq7pGTY43uKMqxWvhkOiYsMhyyI07yIEITY1m9_v_kCyqaPM2UrbwBgCIqMYmg-vg/exec";
    const MAX_ROWS = 30;
    let displayData = [];

    function norm(s) {
      return (s ?? "").toString().toLowerCase().trim();
    }

    function formatTanggal(input) {
      const date = new Date(input);
      if (isNaN(date)) return input;

      const bulanIndonesia = [
        "Januari", "Februari", "Maret", "April", "Mei", "Juni",
        "Juli", "Agustus", "September", "Oktober", "November", "Desember"
      ];

      const hari = date.getDate();
      const bulan = bulanIndonesia[date.getMonth()];
      const tahun = date.getFullYear();

      return `${hari} ${bulan} ${tahun}`;
    }

    async function fetchData() {
      try {
        const response = await fetch(API_URL);
        const data = await response.json();

        data.sort((a, b) => new Date(norm(b["Tanggal Berangkat"])) - new Date(norm(a["Tanggal Berangkat"])));

        const belumTerbayar = data.filter(row => norm(row["Status Penyelesaian"]) === "belum terbayar");
        const sudahTerbayar = data.filter(row => norm(row["Status Penyelesaian"]) === "sudah terbayar");

        let gabungan = [...belumTerbayar, ...sudahTerbayar];

        gabungan = gabungan.filter(row => {
          const noSPPD = (row["No SPPD / Nama"] ?? "").toString().trim();
          return noSPPD !== "" && noSPPD !== "-" && noSPPD !== "0";
        });

        displayData = gabungan.slice(0, MAX_ROWS);

        const totalSPJBelum = gabungan.filter(row => norm(row["Status SPJ"]) === "belum diserahkan").length;
        const totalPenyelesaianBelum = gabungan.filter(row => norm(row["Status Penyelesaian"]) === "belum terbayar").length;

        document.getElementById("status-summary").innerHTML = `
          SPJ Belum Diserahkan: <strong>${totalSPJBelum}</strong> |
          SPPD Belum Dibayarkan: <strong>${totalPenyelesaianBelum}</strong>
        `;

        renderTable(displayData);
      } catch (error) {
        console.error("Gagal ambil data:", error);
      }
    }

    function renderTable(data) {
      const table = document.getElementById("data-table");
      table.innerHTML = "";

      if (!data || data.length === 0) {
        table.innerHTML = "<tr><td>Tidak ada data</td></tr>";
        return;
      }

      const allowedHeaders = [
        "Tanggal Berangkat",
        "Tanggal Pulang",
        "Tujuan",
        "Uraian",
        "No SPPD / Nama",
        "Status SPJ",
        "Status Penyelesaian"
      ];

      const headerRow = document.createElement("tr");
      allowedHeaders.forEach(header => {
        const th = document.createElement("th");
        th.textContent = header;
        headerRow.appendChild(th);
      });
      table.appendChild(headerRow);

      data.forEach(row => {
        const tr = document.createElement("tr");
        const status = norm(row["Status Penyelesaian"]);
        if (status === "belum terbayar") {
          tr.classList.add("belum");
        }

        allowedHeaders.forEach(header => {
          const td = document.createElement("td");
          let value = row[header] ?? "";

          if (header.toLowerCase().includes("tanggal")) {
            value = formatTanggal(value);
            td.textContent = value;
          } else if (header === "No SPPD / Nama") {
            const entries = value.split(/(?=\d{3}[.\s])/);
            const formatted = entries.map(e => e.trim()).join("<br>");
            td.innerHTML = formatted;
          } else {
            td.textContent = value;
          }

          tr.appendChild(td);
        });

        table.appendChild(tr);
      });
    }

    function highlightVisibleRow() {
      const container = document.getElementById("scroll-container");
      const rows = container.querySelectorAll("tr:not(:first-child)");

      rows.forEach(row => row.classList.remove("active"));

      for (const row of rows) {
        const rect = row.getBoundingClientRect();
        const containerRect = container.getBoundingClientRect();
        const middle = containerRect.top + containerRect.height / 2;

        if (rect.top <= middle && rect.bottom >= middle) {
          row.classList.add("active");
          break;
        }
      }
    }

    function autoScroll() {
      const container = document.getElementById("scroll-container");
      if (!container) return;

      const maxScroll = container.scrollHeight - container.clientHeight;
      container.scrollTop += 1;

      if (container.scrollTop >= maxScroll) {
        container.scrollTop = 0;
      }

      highlightVisibleRow();
    }

    setInterval(fetchData, 10000);

    fetchData().then(() => {
      const container = document.getElementById("scroll-container");
      container.scrollTop = 0;
      highlightVisibleRow();
    });

    setTimeout(() => {
      setInterval(autoScroll, 40);
    }, 10000); // jeda 10 detik sebelum scroll otomatis dimulai
  </script>
</body>
</html>

